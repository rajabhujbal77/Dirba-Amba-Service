import{r as l,j as e}from"./vendor-radix-BK0gN1wx.js";import{h as ee,d as te,e as se,s as re,b as ae,f as ne,i as ie,t as le,q as L}from"./index-ByUUsPfb.js";import{i as oe}from"./networkErrors-Btgq6y-X.js";import"./vendor-react-BRY8hXab.js";import"./vendor-pdf-DRk-497H.js";import"./vendor-state-B-0uGrSJ.js";function fe({userRole:k,assignedDepotId:g}){const{draft:f,hasDraft:$,saveDraft:D,clearDraft:u,lastSavedAt:h,selectedBookings:P,setSelectedBookings:C,pendingTripId:de,setPendingTripId:T}=ee(),I=te(t=>t.isOnline);se(t=>t.pendingOperations);const[n,p]=l.useState({driverName:"",driverPhone:"",vehicleNumber:"",tripCost:""}),[i,m]=l.useState([]),[d,A]=l.useState([]),[ce,z]=l.useState([]),[v,U]=l.useState(null),[N,Y]=l.useState(!0),[V,_]=l.useState(!0),[E,O]=l.useState(!1),[me,H]=l.useState([]),[M,y]=l.useState(!1),[b,j]=l.useState(null),G=t=>/^[6-9]\d{9}$/.test(t);l.useEffect(()=>{$&&f&&h&&((Date.now()-new Date(h).getTime())/36e5<24?y(!0):u())},[]),l.useEffect(()=>{const t=setTimeout(()=>{(n.driverName||n.vehicleNumber||i.length>0)&&(D(n),C(i))},1e3);return()=>clearTimeout(t)},[n,i,D,C]),l.useEffect(()=>{R()},[]);const R=async()=>{_(!0);try{const[t,s,r]=await Promise.all([re.get(),ae.getAll(),ne.getAll()]);if(t.season&&t.season.startDate&&t.season.endDate){U(t.season);const a=new Date,c=new Date(t.season.startDate),x=new Date(t.season.endDate);Y(a>=c&&a<=x)}if(k==="depot_manager"&&g){const c=(await ie.getByDepotId(g)).forwardingDepotIds||[];H(c),console.log("Forwarding destinations for depot:",g,c);const x=(s.bookings||[]).filter(o=>["in_transit","reached_depot"].includes(o.status)&&c.includes(o.destination_depot_id));A(x)}else{const a=(s.bookings||[]).filter(c=>c.status==="booked");A(a)}z(r.depots||[])}catch(t){console.error("Error loading data:",t)}finally{_(!1)}},J=async t=>{var s,r;if(t.preventDefault(),!N){alert("Cannot create trips outside of the season dates. Please contact admin to update season settings.");return}if(i.length===0){alert("Please select at least one booking for this trip.");return}if(!n.driverName||!n.driverPhone||!n.vehicleNumber){alert("Please fill in all required fields.");return}if(!G(n.driverPhone)){j("Please enter a valid 10-digit Indian mobile number (starting with 6, 7, 8, or 9)");return}j(null),O(!0);try{const a=d.find(o=>i.includes(o.id)),c=k==="depot_manager"&&g,x={driver:n.driverName,driverPhone:n.driverPhone,vehicle:n.vehicleNumber,tripCost:parseFloat(n.tripCost)||0,originId:c?g:(a==null?void 0:a.origin_depot_id)||null,destinationId:(a==null?void 0:a.destination_depot_id)||null,departure:new Date().toISOString(),eta:new Date(Date.now()+1440*60*1e3).toISOString(),isForwarding:c};if(I)try{const o=await le.create(x,i);alert(`Trip created successfully! Trip Number: ${((s=o.trip)==null?void 0:s.trip_number)||((r=o.trip)==null?void 0:r.id)||"Created"}`),u(),p({driverName:"",driverPhone:"",vehicleNumber:"",tripCost:""}),m([]),R()}catch(o){if(console.error("Error creating trip:",o),oe(o)){console.log("[TripCreation] Network error detected, queuing operation");const F=L("CREATE_TRIP",{tripData:x,bookingIds:i},{entityType:"trip",optimisticData:{formData:n,selectedBookings:i,createdAt:new Date().toISOString()}});T(F),alert(`Trip saved offline! Reference: TRIP-${F.slice(-8).toUpperCase()}. It will be synced when you're back online.`),u(),p({driverName:"",driverPhone:"",vehicleNumber:"",tripCost:""}),m([])}else alert("Error creating trip. Please try again.")}else{const o=L("CREATE_TRIP",{tripData:x,bookingIds:i},{entityType:"trip",optimisticData:{formData:n,selectedBookings:i,createdAt:new Date().toISOString()}});T(o),alert(`Trip saved offline! Reference: TRIP-${o.slice(-8).toUpperCase()}. It will be synced when you're back online.`),u(),p({driverName:"",driverPhone:"",vehicleNumber:"",tripCost:""}),m([])}}catch(a){console.error("Error creating trip:",a),alert("Error creating trip. Please try again.")}finally{O(!1)}},w=t=>{p({...n,[t.target.name]:t.target.value})},K=t=>{m(s=>s.includes(t)?s.filter(r=>r!==t):[...s,t])},Q=()=>{i.length===d.length?m([]):m(d.map(t=>t.id))},S=t=>{const s=[];return Array.isArray(t.receivers)&&t.receivers.forEach(r=>{Array.isArray(r.packages)&&r.packages.forEach(a=>{s.push({size:a.size||"Other",quantity:Number(a.quantity)||0})})}),s},B=d.filter(t=>i.includes(t.id)),W=B.reduce((t,s)=>t+S(s).reduce((r,a)=>r+a.quantity,0),0),X=B.reduce((t,s)=>t+(Number(s.total_amount)||0),0),Z=d.reduce((t,s)=>(S(s).forEach(r=>{t[r.size]=(t[r.size]||0)+r.quantity}),t),{}),q=d.reduce((t,s)=>{const r=s.destination_depot_name||"Unknown";return t[r]||(t[r]={bookings:[],packages:{}}),t[r].bookings.push(s),S(s).forEach(a=>{t[r].packages[a.size]=(t[r].packages[a.size]||0)+a.quantity}),t},{});return V?e.jsx("div",{className:"p-4 md:p-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading trip data..."})]})}):e.jsxs("div",{className:"p-4 md:p-8 max-w-full overflow-x-hidden",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900 mb-2",children:"Trip Creation"}),e.jsx("p",{className:"text-gray-600",children:"Create a new transport trip and assign bookings"})]}),!N&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-xl p-6 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-red-800 mb-1",children:"Season Inactive"}),e.jsxs("p",{className:"text-sm text-red-700",children:["Trips cannot be created outside the season dates",v&&` (${new Date(v.startDate).toLocaleDateString("en-IN")} - ${new Date(v.endDate).toLocaleDateString("en-IN")})`,". Please contact the administrator to update season settings."]})]})]})}),M&&e.jsx("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-2xl",children:"ðŸ“"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-blue-900",children:"Resume Previous Trip?"}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["You have an unsaved trip draft from ",h?new Date(h).toLocaleString():"earlier","."]}),e.jsxs("div",{className:"flex gap-3 mt-3",children:[e.jsx("button",{onClick:()=>{f&&p(f),P.length>0&&m(P),y(!1)},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium",children:"Resume Trip"}),e.jsx("button",{onClick:()=>{u(),y(!1)},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-medium",children:"Start Fresh"})]})]})]})}),!I&&e.jsx("div",{className:"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-amber-800",children:"You're currently offline. "}),e.jsx("span",{className:"text-amber-700",children:"Your trip will be saved and submitted when you're back online."})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"font-bold text-gray-900 mb-4",children:"System Inventory - Pending Bookings"}),e.jsx("div",{className:"w-[calc(100vw-2rem)] md:w-[calc(100vw-320px)] max-w-full overflow-hidden -mx-4 md:mx-0 px-4 md:px-0",children:e.jsxs("div",{className:"flex gap-3 md:gap-4 overflow-x-auto pb-3 snap-x snap-mandatory",children:[d.length>0&&e.jsxs("div",{className:"bg-orange-50 rounded-lg border-2 border-orange-300 p-3 md:p-4 min-w-[160px] md:min-w-[180px] max-w-[180px] md:max-w-[200px] flex-shrink-0 snap-start",children:[e.jsx("p",{className:"text-sm font-bold text-orange-700 mb-2",children:"ðŸ“¦ Total Inventory"}),e.jsxs("p",{className:"text-xs text-gray-600 mb-2",children:[d.length," total bookings"]}),e.jsx("div",{className:"space-y-1 max-h-[140px] overflow-y-auto",children:Object.entries(Z).map(([t,s])=>e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-gray-700",children:t}),e.jsx("span",{className:"font-bold text-orange-700 ml-2",children:s})]},t))})]}),Object.entries(q).map(([t,s])=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 min-w-[160px] md:min-w-[180px] max-w-[180px] md:max-w-[200px] flex-shrink-0 snap-start",children:[e.jsx("p",{className:"text-sm font-bold text-gray-900 truncate mb-2",children:t}),e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:[s.bookings.length," bookings"]}),e.jsxs("div",{className:"space-y-1 max-h-[140px] overflow-y-auto",children:[Object.entries(s.packages).map(([r,a])=>e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600 truncate",children:r}),e.jsx("span",{className:"font-bold text-orange-600 ml-2",children:a})]},r)),Object.keys(s.packages).length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"No packages"})]})]},t)),Object.keys(q).length===0&&e.jsx("div",{className:"flex-1 bg-gray-50 rounded-lg p-6 text-center text-gray-500",children:"No pending bookings available"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-6 sticky top-8",children:[e.jsx("h2",{className:"font-bold text-gray-900 mb-4",children:"Trip Details"}),e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"driverName",className:"block text-sm font-medium text-gray-700 mb-1",children:"Driver Name *"}),e.jsx("input",{id:"driverName",name:"driverName",type:"text",value:n.driverName,onChange:w,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent",placeholder:"Enter driver name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"driverPhone",className:"block text-sm font-medium text-gray-700 mb-1",children:"Driver Phone *"}),e.jsx("input",{id:"driverPhone",name:"driverPhone",type:"tel",value:n.driverPhone,onChange:t=>{const s=t.target.value.replace(/\D/g,"");p({...n,driverPhone:s}),b&&j(null)},className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent ${b?"border-red-500":"border-gray-300"}`,placeholder:"10-digit number (e.g., 9876543210)",maxLength:10,required:!0}),b&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:b})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"vehicleNumber",className:"block text-sm font-medium text-gray-700 mb-1",children:"Vehicle Number *"}),e.jsx("input",{id:"vehicleNumber",name:"vehicleNumber",type:"text",value:n.vehicleNumber,onChange:w,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent",placeholder:"e.g., MH-12-AB-1234",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tripCost",className:"block text-sm font-medium text-gray-700 mb-1",children:"Trip Cost (â‚¹)"}),e.jsx("input",{id:"tripCost",name:"tripCost",type:"number",value:n.tripCost,onChange:w,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent",placeholder:"Optional"})]}),e.jsxs("div",{className:"bg-orange-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Selected Bookings"}),e.jsx("span",{className:"font-bold text-orange-600",children:i.length})]}),e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Total Packages"}),e.jsx("span",{className:"font-bold text-gray-900",children:W})]}),e.jsxs("div",{className:"flex justify-between items-center border-t border-orange-200 pt-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Total Value"}),e.jsxs("span",{className:"font-bold text-green-600",children:["â‚¹",X.toLocaleString("en-IN")]})]})]}),e.jsx("button",{type:"submit",disabled:E||i.length===0||!N,className:"w-full px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:E?"Creating Trip...":"Create Trip"})]})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-gray-900",children:"Select Bookings"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[d.length," bookings available for assignment"]})]}),e.jsx("button",{type:"button",onClick:Q,className:"px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:i.length===d.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"max-h-[600px] overflow-y-auto divide-y divide-gray-200",children:d.length>0?d.map(t=>e.jsxs("label",{className:`flex items-start gap-4 p-4 cursor-pointer hover:bg-gray-50 transition-colors ${i.includes(t.id)?"bg-orange-50":""}`,children:[e.jsx("input",{type:"checkbox",checked:i.includes(t.id),onChange:()=>K(t.id),className:"mt-1 w-5 h-5 text-orange-500 border-gray-300 rounded focus:ring-orange-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.sender_name}),e.jsx("p",{className:"text-sm text-gray-600",children:t.sender_phone})]}),e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded",children:t.receipt_number})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-4 text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:["ðŸ“ ",t.origin_depot_name||"Origin"," â†’ ",t.destination_depot_name||"Destination"]}),e.jsxs("span",{className:"font-medium text-green-600",children:["â‚¹",(Number(t.total_amount)||0).toLocaleString("en-IN")]})]}),t.package_details&&Array.isArray(t.package_details)&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:t.package_details.map((s,r)=>e.jsxs("span",{className:"px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded",children:[s.name||s.packageName,": ",s.quantity]},r))})]})]},t.id)):e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx("p",{className:"text-lg mb-2",children:"No pending bookings"}),e.jsx("p",{className:"text-sm",children:"All bookings have been assigned to trips or delivered."})]})})]})})]})]})}export{fe as default};
//# sourceMappingURL=TripCreation-DwUWZCsD.js.map
